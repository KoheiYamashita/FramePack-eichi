# FramePack-eichi

FramePack-eichiは、lllyasviel師の[lllyasviel/FramePack](https://github.com/lllyasviel/FramePack)のフォークであるnirvash氏の[nirvash/FramePack](https://github.com/nirvash/FramePack)を元にして作成された機能追加バージョンです。nirvash氏の先駆的な改良に基づき、細かい機能が多数搭載されています。

![FramePack-eichi画面1](images/framepack_eichi_screenshot1.png)

## 📘 名称の由来

**Endframe Image CHain Interface (EICHI)**
- **E**ndframe: エンドフレーム機能の強化と最適化
- **I**mage: キーフレーム画像処理の改善と視覚的フィードバック
- **CH**ain: 複数のキーフレーム間の連携と関係性の強化
- **I**nterface: 直感的なユーザー体験とUI/UXの向上

「eichi」は日本語の「叡智」（深い知恵、英知）を連想させる言葉でもあり、AI技術の進化と人間の創造性を組み合わせるという本プロジェクトの哲学を象徴しています。
つまり叡智な差分画像から動画を作成することに特化した現地改修仕様です。

## 🌟 主な機能

- **高品質な動画生成**: 単一画像から自然な動きの動画を生成　※既存機能
- **柔軟な動画長設定**: 1〜20秒の各セクションモードに対応　※独自機能
- **セクションフレームサイズ設定**: 0.5秒モードと1秒モードを切り替え可能　※v1.5で追加
- **オールパディング機能**: すべてのセクションで同じパディング値を使用　※v1.4で追加
- **マルチセクション対応**: 複数のセクションでキーフレーム画像を指定し複雑なアニメーションを実現　※nirvash氏追加機能
- **セクションごとのプロンプト設定**: 各セクションに個別のプロンプトを指定可能　※v1.2で追加
- **赤枠/青枠によるキーフレーム画像効率的コピー**: 2つのキーフレームだけで全セクションをカバー可能に　※v1.7で追加
- **プロンプト管理機能**: プロンプトの保存、編集、再利用が簡単　※v1.3で追加
- **MP4圧縮設定**: 動画のファイルサイズと品質のバランスを調整可能　※v1.6.2で本家からマージ
- **【試験実装中】Hunyuan LoRAサポート**: モデルのカスタマイズによる独自の表現を追加　※v1.3で追加
- **出力フォルダ管理機能**: 出力先フォルダの指定とOSに依存しない開き方をサポート ※v1.2で追加
- **ログ機能**: 詳細な経過情報や終了時に処理時間を出したりWindowsだと音を出したりします　※独自機能
- **クロスプラットフォーム対応**: Windows以外の環境でも基本機能が使用可能　※多分

![FramePack-eichi画面2](images/framepack_eichi_screenshot2.png)

## 📝 最新アップデート情報 (v1.7.1)

### 主要な変更点

#### 1. 内部計算の最適化
- **0.5秒モードの処理改善**: セクション数計算がより正確になり、動画生成の安定性が向上しました。

#### 2. UIの改善
- **動画モード表示の簡素化**: 動画モード名から冗長な括弧表記を削除（例: "10(5x2)秒" → "10秒"）
- **レイアウトの整理**: UI全体が整理され、より使いやすくなりました

### 終点およびキーフレーム画像の持続性問題（対応検討中）

一部のユーザーから以下の問題が報告されており、現在対応を検討中です：

- 生成中止後に再度生成を開始すると、終点およびキーフレーム画像が使用されないことがある
- 画像を一度削除して再アップロードすると問題が解決するが、生成を開始するまで問題に気づきにくい
- この問題が確認された場合、一度画像を閉じて再度アップロードし直してください
- v1.5.1でStartボタンを押した場合に明示的に画像を再取得するように見直し実施しました

### Hunyuan LoRA対応状況

暫定対応状態となります：

- v1.6ではLoRA適用ロジックが統一され、高VRAMモードと低VRAMモードで同じ直接適用方式を使用
- VRAM管理の基準値が変更され（60GB→100GB）、より多くのユーザーが低VRAMモードで動作可能に
- 使用にはVRAM16GBでも少し厳しめだが、処理自体よりも開始前のディスク読込の方が長い。メモリは多め推奨
- VRAMの多いPCで正常に動作しないという問い合わせも来ており、抜本見直しも検討中です

## 💻 インストール方法

### 前提条件

- Windows 10/11（Linux/Macでも基本機能は多分動作可能）
- NVIDIA GPU (RTX 30/40シリーズ推奨、最低8GB VRAM)
- CUDA Toolkit 12.6
- Python 3.10.x
- 最新のNVIDIA GPU ドライバー

※ Linuxでの動作はv1.2で強化され、オープン機能も追加されましたが、一部機能に制限がある場合があります。

### 手順

#### 公式パッケージのインストール

まず、元のFramePackをインストールする必要があります。

1. [公式FramePack](https://github.com/lllyasviel/FramePack?tab=readme-ov-file#installation)からWindowsワンインストーラーをダウンロードします。
   「Click Here to Download One-Click Package (CUDA 12.6 + Pytorch 2.6)」をクリックします。

2. ダウンロードしたパッケージを解凍し、`update.bat`を実行してから`run.bat`で起動します。
   `update.bat`の実行は重要です。これを行わないと、潜在的なバグが修正されていない以前のバージョンを使用することになります。

3. 初回起動時に必要なモデルが自動的にダウンロードされます（約30GB）。
   既にダウンロード済みのモデルがある場合は、`framepack\webui\hf_download`フォルダに配置してください。

4. この時点で動作しますが、高速化ライブラリ（Xformers、Flash Attn、Sage Attn）が未インストールの場合、処理が遅くなります。
   ```
   Currently enabled native sdp backends: ['flash', 'math', 'mem_efficient', 'cudnn']
   Xformers is not installed!
   Flash Attn is not installed!
   Sage Attn is not installed!
   ```
   
   処理時間の違い: ※RAM:32GB、RXT4060Ti(16GB)の場合
   - ライブラリ未インストール時: 約4分46秒/25ステップ
   - ライブラリインストール時: 約3分17秒〜3分25秒/25ステップ

5. 高速化ライブラリをインストールするには、[Issue #138](https://github.com/lllyasviel/FramePack/issues/138)から`package_installer.zip`をダウンロードし、解凍してルートディレクトリで`package_installer.bat`を実行します（コマンドプロンプト内でEnterを押す）。

6. 再度起動してライブラリがインストールされたことを確認します:
   ```
   Currently enabled native sdp backends: ['flash', 'math', 'mem_efficient', 'cudnn']
   Xformers is installed!
   Flash Attn is not installed!
   Sage Attn is installed!
   ```
   作者が実行した場合、Flash Attnはインストールされませんでした。
   注: Flash Attnがインストールされていなくても、処理速度にはほとんど影響がありません。テスト結果によると、Flash Attnの有無による速度差はわずかで、「Flash Attn is not installed!」の状態でも約3分17秒/25ステップと、すべてインストールされている場合（約3分25秒/25ステップ）とほぼ同等の処理速度を維持できます。
   Xformersが入っているかどうかが一番影響が大きいと思います。

#### FramePack-eichiのインストール

1. `run_endframe_ichi.bat`をFramePackのルートディレクトリに配置します。
2. 以下のファイルとフォルダを`webui`フォルダに配置します：
   - `endframe_ichi.py` - メインアプリケーションファイル
   - `eichi_utils` フォルダ - ユーティリティモジュール（v1.3.1で見直し、v1.6.2でUI関連モジュール追加）
     - `__init__.py`
     - `frame_calculator.py` - フレームサイズ計算モジュール
     - `keyframe_handler.py` - キーフレーム処理モジュール
     - `keyframe_handler_extended.py` - キーフレーム処理モジュール
     - `preset_manager.py` - プリセット管理モジュール
     - `settings_manager.py` - 設定管理モジュール
     - `ui_styles.py` - UIスタイル定義モジュール（v1.6.2で追加）
     - `video_mode_settings.py` - 動画モード設定モジュール
   - `lora_utils` フォルダ - LoRA関連モジュール（v1.3で追加、v1.3.2で改良）
     - `__init__.py`
     - `dynamic_swap_lora.py` - LoRA管理モジュール（フック方式は廃止され、直接適用方式のみサポート）
     - `lora_loader.py` - LoRAローダーモジュール
     - `lora_check_helper.py` - LoRA適用状況確認モジュール（v1.3.2で追加）

3. `run_endframe_ichi.bat`を実行すると、FramePack-eichiのWebUIが起動します。

#### Linux向けインストール方法

Linuxでは、以下の手順で実行可能です：

1. 上記の必要なファイルとフォルダをダウンロードして配置します。
2. ターミナルで次のコマンドを実行します：
   ```bash
   python endframe_ichi.py
   ```

#### Google Colab向けインストール方法

- [Google Colab で FramePack を試す](https://note.com/npaka/n/n33d1a0f1bbc1)をご参考ください

#### Mac(mini M4 Pro)向けインストール方法

- [話題のFramePackをMac mini M4 Proで動かしてみた件](https://note.com/akira_kano24/n/n49651dbef319)をご参考ください

## 🚀 使い方

### 基本的な動画生成　※既存機能

1. **画像をアップロード**: 「Image」枠に画像をアップロード
2. **プロンプトを入力**: キャラクターの動きを表現するプロンプトを入力
3. **設定を調整**: 動画長やシード値を設定
4. **生成開始**: 「Start Generation」ボタンをクリック

### 高度な設定

- **生成モード選択**:　※独自機能
  - **通常モード**: 一般的な動画生成
  - **ループモード**: 最終フレームが最初のフレームに戻る循環動画を生成

- **オールパディング選択**:　※v1.4で追加、この値が小さいほど1セッションでの動きが激しくなる
  - **オールパディング**: すべてのセクションで同じパディング値を使用
  - **パディング値**: 0〜3の整数値

- **動画長設定**:　※独自機能の拡張
  - **1～20秒**

[続きはこちら](README_column.md#-高度な設定)

## 🛠️ 設定情報

設定に関する詳細情報は[こちら](README_column.md#-%EF%B8%8F-設定情報)をご覧ください。

## 🔧 トラブルシューティング

### h11エラーについて

ツールを立ち上げ、初回に画像をインポートする際に以下のようなエラーが多数発生することがあります：
※コンソールにエラーが表示され、GUI上では画像が表示されません。

**実際には画像はアップロードされており、サムネイルの表示に失敗しているケースが大半のため、そのまま動画生成いただくことも可能です。**

![FramePack-eichiエラー画面1](images/framepack_eichi_error_screenshot1.png)
```
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "C:\xxx\xxx\framepack\system\python\lib\site-packages\uvicorn\protocols\http\h11_impl.py", line 404, in run_asgi
```
このエラーは、HTTPレスポンスの処理中に問題が発生した場合に表示されます。
前述のとおり、Gradioが起動し終わっていない起動初期の段階で頻発します。

解決方法：
1. 画像を一度「×」ボタンで削除して、再度アップロードしてみてください。
2. 同じファイルで何度も失敗する場合：
   - Pythonプロセスを完全に停止してからアプリケーションを再起動
   - PCを再起動してからアプリケーションを再起動

エラーが継続する場合は、他の画像ファイルを試すか、画像サイズを縮小してみてください。

### メモリ不足エラー

「CUDA out of memory」や「RuntimeError: CUDA error」が表示される場合：

1. `gpu_memory_preservation` の値を大きくする（例: 12-16GB）
2. 他のGPUを使用するアプリケーションを閉じる
3. 再起動して再試行
4. 画像解像度を下げる（640x640前後推奨）

### 動画表示の問題

一部のブラウザ（特にFirefoxなど）やmacOSで生成された動画が表示されない問題があります：

- 症状: Gradio UI上で動画が表示されない、Windowsでサムネイルが表示されない、一部のプレイヤーで再生できない
- 原因: `\framepack\webui\diffusers_helper\utils.py`内のビデオコーデック設定の問題

**こちらについては本家のMP4 Compression機能をマージし解消しました**

## 🤝 謝辞

このプロジェクトは以下のプロジェクトの貢献に基づいています：

- [lllyasviel/FramePack](https://github.com/lllyasviel/FramePack) - 原作者lllyasviel師の素晴らしい技術と革新性に感謝します
- [nirvash/FramePack](https://github.com/nirvash/FramePack) - nirvash氏の先駆的な改良と拡張に深く感謝します

## 📄 ライセンス

本プロジェクトは[Apache License 2.0](LICENSE)の下で公開されています。これは元のFramePackプロジェクトのライセンスに準拠しています。

## 📝 更新履歴

### 2025-04-28: バージョン1.7.1
- **内部計算の最適化**:
  - 0.5秒モードのセクション数計算が正確になり、動画生成の安定性が向上
  - フレーム計算パラメータ（latent_window_size）が5から4.5に変更
- **UIの改善**:
  - 動画モード名の簡素化: 括弧付き表記を削除（例: "10(5x2)秒" → "10秒"）
  - レイアウトの整理: UI全体が整理され、より使いやすくなりました

### 2025-04-28: バージョン1.7.0
- **キーフレーム画像コピー機能の大幅改良**:
  - 赤枠/青枠による視覚的な区別を導入
  - **赤枠(セクション0)** ⇒ すべての偶数番号セクション(0,2,4,6...)に自動コピー
  - **青枠(セクション1)** ⇒ すべての奇数番号セクション(1,3,5,7...)に自動コピー
  - 動的セクション数計算の精度向上により、選択した動画長に応じて正確にコピー範囲を調整
  - ユーザーが必要に応じてコピー機能のオン/オフを切り替え可能に
- **コピー処理の安全性向上**:
  - セクション境界チェックを強化し、無効な位置へのコピーを防止
  - 詳細なログ出力によりコピー動作の追跡が容易に

### 2025-04-27: バージョン1.6.2
- **MP4圧縮設定の追加**: ※本家からマージ
  - 動画のファイルサイズと品質のバランスを調整可能に
  - 0〜100の範囲で設定可能（0=無圧縮、16=デフォルト、高い値=高圧縮・低品質）
  - 黒画面問題対策として最適な設定値を提供
- **コード品質の向上**:
  - UIスタイル定義を`ui_styles.py`として分離し、保守性と可読性を改善
  - CSSスタイルの一元管理によりUI一貫性を向上
- **フレームサイズ計算の微調整**:
  - 0.5秒モードの計算精度を向上（`latent_window_size=4.5`を使用）
  - セクション数と動画長の計算精度が向上し、より安定した動画生成が可能に

### 2025-04-26: バージョン1.6.1
- **短時間動画モードの拡充**:
  - 2秒モード: 60フレーム（2秒×30FPS）、2セクション、コピー不要
  - 3秒モード: 90フレーム（3秒×30FPS）、3セクション、キーフレーム0→1にコピー
  - 4秒モード: 120フレーム（4秒×30FPS）、4セクション、キーフレーム0→1,2にコピー
- **v1.5.1の基本構造に回帰**:
  - オリジナルのモード名表記（カッコ付き）を維持
  - キーフレームガイドHTMLを復活
  - 元々の関数構造・処理方法を維持

### 2025-04-26: バージョン1.6.0 ※却下版
- **UI/UX改善**:
  - セクション設定をアコーディオンとして分離し、必要時のみ展開可能に
  - 動画モード名の簡素化（例：「10(5x2)秒」→「10秒」）
  - キーフレーム強調表示の削除
  - 不要な機能（EndFrame影響度調整、キーフレーム自動コピー機能）を内部設定に変更
- **技術的な改善**:
  - VRAM管理の基準値変更（60GB→100GB）
  - セクション計算ロジックの改善（直接秒数から計算する機能追加）
  - フレーム数・セクション数の一貫性向上（表示秒数との整合性確保）
  - デバッグ出力の最適化

### 2025-04-25: バージョン1.5.1
- **短い動画生成向けの「1秒」モードを追加**:
  - 1秒（約30フレーム @ 30fps）に対応
- **デフォルト動画長を変更**:
  - 「6秒」から「1秒」にデフォルト値を変更
- **入力画像のコピー動作の最適化**:
  - 通常モードでの入力画像からのコピー処理を停止
  - ループモードでのみLastにコピーする処理を有効化
- **キーフレーム自動コピー機能のデフォルト値を変更**:
  - デフォルトでオフに設定し、より細かな制御を可能に
  - 必要な場合はオンにすることで自動コピー可能
- **画像処理の安定性向上**:
  - Startボタンを押した時に画像が正しく再取得されるよう改善
  - プレビュー画像の明示的なクリア処理を追加

### 2025-04-24: バージョン1.5.0
- **フレームサイズ設定の追加**:
  - 0.5秒モードと1秒モードを切り替え可能
  - フレームサイズによってlatent_window_sizeを動的に調整

### 2025-04-24: バージョン1.4.0
- **オールパディング機能の追加**:
  - すべてのセクションで同じパディング値を使用
  - この値が小さいほど1セッションでの動きが激しくなる

### 2025-04-24: バージョン1.3.3
- **LoRA適用機能の再見直し**:
  - 直接LoRAロードモードはパラメタの設定にキー一致が必要なため却下。DynamicSwapに統一して様子見
  - 取得したパラメタ数のログ表示実装

### 2025-04-24: バージョン1.3.2
- **LoRA適用機能の統一**:
  - 低VRAMモード（DynamicSwap）でも高VRAMモードと同様に直接LoRAを適用する方式に統一
  - フック方式を廃止し、より安定した直接適用方式のみをサポート
  - 互換性のためにインターフェースは維持しつつ、内部実装を改善
- **デバッグ・検証機能の強化**:
  - LoRAの適用状況を確認するための専用ユーティリティを追加（lora_check_helper.py）
  - 詳細なログ出力とデバッグ情報の提供

### 2025-04-24: バージョン1.3.1
- **コードベースのリファクタリング**: 保守性と拡張性向上のため、コードを複数のモジュールに整理
  - `eichi_utils`: キーフレーム処理、設定管理、プリセット管理、ビデオモード設定を管理
  - `lora_utils`: LoRA関連の機能を集約

### 2025-04-23: バージョン1.3
- **【調査中】Hunyuan LoRAサポートの追加**: モデルをカスタマイズして独自の表現を追加
- **【試験実装】EndFrame影響度設定の追加**: 最終フレームの影響力を0.01〜1.00の範囲で調整可能に（nirvash氏の知見）

### 2025-04-23: バージョン1.2
- **「20(4x5)秒」モードを追加**: 5パート構成の長時間動画生成に対応
- **セクションごとのプロンプト機能を追加**: 各セクションに個別のプロンプトを設定可能に【試験実装】
- **出力フォルダ管理機能を強化**: 出力先フォルダの指定とOSに依存しない開き方をサポート
- **設定ファイル管理の改善**: JSONベースの設定ファイルで設定を永続化
- **クロスプラットフォーム対応の強化**: Windows以外の環境での動作を改善

### 2025-04-22: バージョン1.1
- **「16(4x4)秒」モードを追加**: 4パート構成の長時間動画生成に対応
- **生成処理中の進捗表示を改善**: セクション情報（例：「セクション: 3/15」）が表示されるようになり、特に長い動画生成時の進捗が把握しやすくなりました
- **設定ファイルの構造化**: 動画モード設定が別ファイルに分離され、拡張性が向上

### 2025-04-21: 初版リリース
- プロンプト管理機能の最適化
- キーフレームガイド機能の追加

---
**FramePack-eichi** - Endframe Image CHain Interface  
より直感的で、より柔軟な動画生成を目指して
